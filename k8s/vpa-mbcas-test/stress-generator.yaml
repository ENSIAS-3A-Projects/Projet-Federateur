# Stress/load generator pod for testing
apiVersion: v1
kind: Pod
metadata:
  name: stress-generator
  namespace: vpa-mbcas-test
  labels:
    app: stress-generator
    mbcas.io/managed: "false"
spec:
  containers:
  - name: stress
    image: curlimages/curl:latest
    command: ["/bin/sh"]
    args:
    - -c
    - |
      echo "Stress generator started. Waiting for services..."
      sleep 15
      
      # Simple load generator using curl
      generate_load() {
        local target=$1
        local rps=$2
        local duration=$3
        local phase=$4
        
        echo "[$(date +%H:%M:%S)] Phase: $phase - Target: $target, RPS: $rps, Duration: ${duration}s"
        local end_time=$(($(date +%s) + duration))
        local requests=0
        local sleep_time=$(awk "BEGIN {printf \"%.3f\", 1/$rps}")
        
        while [ $(date +%s) -lt $end_time ]; do
          curl -s -m 5 "$target" > /dev/null 2>&1 || true
          requests=$((requests + 1))
          sleep $sleep_time
        done
        echo "[$(date +%H:%M:%S)] Completed $phase: $requests requests"
      }
      
      # Test scenarios
      GATEWAY_BASELINE="http://gateway-baseline:8080"
      GATEWAY_VPA="http://gateway-vpa:8080"
      GATEWAY_MBCAS="http://gateway-mbcas:8080"
      
      # Phase 1: Warmup (low load) - 2 minutes
      echo "=== PHASE 1: WARMUP (2 minutes) ==="
      generate_load "$GATEWAY_BASELINE" 10 120 "baseline-warmup" &
      generate_load "$GATEWAY_VPA" 10 120 "vpa-warmup" &
      generate_load "$GATEWAY_MBCAS" 10 120 "mbcas-warmup" &
      wait
      
      # Phase 2: Saturation (moderate load) - 5 minutes
      echo "=== PHASE 2: SATURATION (5 minutes) ==="
      generate_load "$GATEWAY_BASELINE" 50 300 "baseline-saturation" &
      generate_load "$GATEWAY_VPA" 50 300 "vpa-saturation" &
      generate_load "$GATEWAY_MBCAS" 50 300 "mbcas-saturation" &
      wait
      
      # Phase 3: Contention (high load) - 5 minutes
      echo "=== PHASE 3: CONTENTION (5 minutes) ==="
      generate_load "$GATEWAY_BASELINE" 100 300 "baseline-contention" &
      generate_load "$GATEWAY_VPA" 100 300 "vpa-contention" &
      generate_load "$GATEWAY_MBCAS" 100 300 "mbcas-contention" &
      wait
      
      # Phase 4: Bursty (variable load with spikes) - 3 minutes
      echo "=== PHASE 4: BURSTY (3 minutes) ==="
      for i in $(seq 1 18); do
        if [ $((i % 3)) -eq 0 ]; then
          # Spike: 100 RPS for 10 seconds
          generate_load "$GATEWAY_BASELINE" 100 10 "baseline-burst" &
          generate_load "$GATEWAY_VPA" 100 10 "vpa-burst" &
          generate_load "$GATEWAY_MBCAS" 100 10 "mbcas-burst" &
        else
          # Normal: 50 RPS for 10 seconds
          generate_load "$GATEWAY_BASELINE" 50 10 "baseline-normal" &
          generate_load "$GATEWAY_VPA" 50 10 "vpa-normal" &
          generate_load "$GATEWAY_MBCAS" 50 10 "mbcas-normal" &
        fi
        wait
      done
      
      echo "=== STRESS TEST COMPLETE ==="
      sleep 30
    resources:
      requests:
        cpu: "100m"
        memory: "64Mi"
      limits:
        cpu: "500m"
        memory: "128Mi"
